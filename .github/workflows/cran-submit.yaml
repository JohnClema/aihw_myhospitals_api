name: CRAN Submission

on:
  release:
    types: [prereleased]
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type CONFIRM to submit to CRAN'
        required: true

jobs:
  # ── Gate: must pass Rust CI ──────────────────────────
  rust-ci:
    name: Rust CI
    if: >-
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'CONFIRM')
    uses: ./.github/workflows/ci.yml

  # ── Gate: must pass R CMD check (strict, Ubuntu only) ─
  r-check:
    name: R CMD check (strict)
    if: >-
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'CONFIRM')
    uses: ./.github/workflows/R-CMD-check.yaml
    with:
      error-on: '"warning"'
      ubuntu-only: true

  # ── Submit to CRAN only after both gates pass ────────
  cran-submit:
    name: Submit to CRAN
    needs: [rust-ci, r-check]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    env:
      NOT_CRAN: false

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: r-package
          extra-packages: any::devtools
          needs: check

      - name: Submit to CRAN
        working-directory: r-package
        run: |
          Rscript -e 'devtools::submit_cran(pkg = ".")'

      - name: Create tracking issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const pkg = require('fs').readFileSync('r-package/DESCRIPTION', 'utf8');
            const version = pkg.match(/Version:\s*(.+)/)[1].trim();
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CRAN submission: aihwmyhospitals v${version}`,
              body: [
                `## CRAN Submission Tracker`,
                ``,
                `**Package:** aihwmyhospitals`,
                `**Version:** ${version}`,
                `**Submitted:** ${new Date().toISOString()}`,
                `**Triggered by:** ${context.actor}`,
                ``,
                `### Next Steps`,
                `- [ ] Check email for CRAN confirmation link`,
                `- [ ] Click confirmation link`,
                `- [ ] Wait for CRAN review (1-5 days)`,
                `- [ ] Address any reviewer feedback`,
                `- [ ] Package accepted on CRAN`
              ].join('\n'),
              labels: ['cran-submission']
            });
