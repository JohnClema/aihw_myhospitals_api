#!/bin/sh
# Configure script for aihwmyhospitals R package
# Checks for Rust toolchain (cargo and rustc) availability

# Minimum Supported Rust Version
MSRV="1.70.0"

# Source cargo environment if available (for Unix systems where cargo is installed via rustup)
if [ -f "$HOME/.cargo/env" ]; then
  . "$HOME/.cargo/env"
fi

# Also try to add cargo to PATH directly
export PATH="$PATH:$HOME/.cargo/bin"

# Function to compare version numbers
version_ge() {
  # Returns 0 (true) if $1 >= $2
  printf '%s\n%s\n' "$2" "$1" | sort -V -C
}

# Check for cargo
if ! command -v cargo >/dev/null 2>&1; then
  echo ""
  echo "-------------------- CONFIGURATION ERROR --------------------"
  echo ""
  echo "Cargo (Rust's package manager) was not found on your system."
  echo ""
  echo "This package requires Rust to compile. Please install Rust from:"
  echo ""
  echo "    https://rustup.rs"
  echo ""
  echo "After installing, you may need to restart your terminal or run:"
  echo ""
  echo "    source \$HOME/.cargo/env"
  echo ""
  echo "--------------------------------------------------------------"
  echo ""
  exit 1
fi

# Check for rustc
if ! command -v rustc >/dev/null 2>&1; then
  echo ""
  echo "-------------------- CONFIGURATION ERROR --------------------"
  echo ""
  echo "Rust compiler (rustc) was not found on your system."
  echo ""
  echo "This package requires Rust to compile. Please install Rust from:"
  echo ""
  echo "    https://rustup.rs"
  echo ""
  echo "--------------------------------------------------------------"
  echo ""
  exit 1
fi

# Get versions
CARGO_VERSION=$(cargo --version 2>/dev/null | sed 's/cargo //')
RUSTC_VERSION=$(rustc --version 2>/dev/null | sed 's/rustc //' | cut -d' ' -f1)

echo "Found cargo: $CARGO_VERSION"
echo "Found rustc: $RUSTC_VERSION"

# Check minimum version
if ! version_ge "$RUSTC_VERSION" "$MSRV"; then
  echo ""
  echo "-------------------- VERSION WARNING --------------------"
  echo ""
  echo "Your Rust version ($RUSTC_VERSION) may be too old."
  echo "This package requires rustc >= $MSRV"
  echo ""
  echo "Please update Rust by running:"
  echo ""
  echo "    rustup update stable"
  echo ""
  echo "---------------------------------------------------------"
  echo ""
  # Don't exit with error, just warn - older versions might still work
fi

echo "Rust toolchain OK"
exit 0
